name: Upload Python Package

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  release-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Verify version matches tag
        id: verify_version
        run: |
          set -euo pipefail
          TAG="${{ github.event.release.tag_name }}"
          TAG_STRIPPED="${TAG#v}"
          echo "Release tag: $TAG"
          PY_VERSION=$(python -c "import re, pathlib; init=pathlib.Path('tvbo/__init__.py').read_text(encoding='utf-8'); import sys; m=re.search(r'__version__\\s*=\\s*[\'\"]([^\'\"]+)[\'\"]', init); print(m.group(1) if m else '')")
          echo "Package version: $PY_VERSION"
          if [ -z "$PY_VERSION" ]; then
            echo "Could not extract __version__ from tvbo/__init__.py" >&2
            exit 1
          fi
          if [ "$PY_VERSION" != "$TAG_STRIPPED" ]; then
            echo "Version mismatch: tag ($TAG_STRIPPED) != package ($PY_VERSION)" >&2
            exit 1
          fi
          echo "version=$PY_VERSION" >> "$GITHUB_OUTPUT"

      - name: Verify CHANGELOG contains version section
        env:
          VERSION: ${{ steps.verify_version.outputs.version }}
        run: |
          set -euo pipefail
          echo "Looking for version $VERSION in CHANGELOG.md"
          if ! grep -Eiq "^##.*(${VERSION})" CHANGELOG.md; then
            echo "CHANGELOG.md does not contain a section for version $VERSION" >&2
            exit 1
          fi

      - name: Build release distributions
        run: |
          python -m pip install --upgrade pip
          pip install build
          python -m build

      - name: Generate checksums (SHA256)
        run: |
          cd dist
          sha256sum * > SHA256SUMS.txt
          echo "Generated checksums:" && cat SHA256SUMS.txt

      - name: Upload distributions
        uses: actions/upload-artifact@v4
        with:
          name: release-dists
          path: dist/

      - name: Update GitHub Release notes from CHANGELOG
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.verify_version.outputs.version }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { owner, repo } = context.repo;
            const releaseId = context.payload.release.id;
            const tagName = context.payload.release.tag_name;
            const version = process.env.VERSION || tagName.replace(/^v/, '');
            const changelogPath = path.join(process.env.GITHUB_WORKSPACE, 'CHANGELOG.md');
            let body = `Release ${tagName}`;
            try {
              const md = fs.readFileSync(changelogPath, 'utf8');
              const lines = md.split(/\r?\n/);
              const headerRegex = new RegExp(`^##\\s.*(${version})`);
              let start = -1, end = lines.length;
              for (let i = 0; i < lines.length; i++) {
                if (headerRegex.test(lines[i])) { start = i; break; }
              }
              if (start >= 0) {
                for (let j = start + 1; j < lines.length; j++) {
                  if (/^##\s/.test(lines[j])) { end = j; break; }
                }
                body = lines.slice(start, end).join('\n').trim();
              } else {
                // fallback: first section if structured, else whole file head
                const firstSectionEnd = lines.findIndex((l, idx) => idx>0 && /^##\s/.test(l));
                body = lines.slice(0, firstSectionEnd > 0 ? firstSectionEnd : Math.min(lines.length, 200)).join('\n').trim();
              }
            } catch (e) {
              core.warning(`Failed to parse CHANGELOG.md: ${e}`);
            }
            await github.rest.repos.updateRelease({ owner, repo, release_id: releaseId, body });

  pypi-publish:
    runs-on: ubuntu-latest
    needs:
      - release-build
    permissions:
      # IMPORTANT: this permission is mandatory for trusted publishing
      id-token: write
    environment:
      name: pypi
      # url: https://pypi.org/project/tvbo

    steps:
      - name: Retrieve release distributions
        uses: actions/download-artifact@v4
        with:
          name: release-dists
          path: dist/

      - name: Publish release distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
